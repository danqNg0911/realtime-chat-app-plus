# CI/CD
name: CI Build & Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: app-chat-478713
      REGION: asia-southeast1
      REPO_NAME: chat
      AR: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build & Push api-gateway
        run: |
          docker build -t $AR/api-gateway:latest services/api-gateway
          docker push $AR/api-gateway:latest

      - name: Build & Push auth-user-service
        run: |
          docker build -t $AR/auth-user-service:latest services/auth-user-service
          docker push $AR/auth-user-service:latest

      - name: Build & Push chat-service
        run: |
          docker build -t $AR/chat-service:latest services/chat-service
          docker push $AR/chat-service:latest

      - name: Build & Push media-ai-service
        run: |
          docker build -t $AR/media-ai-service:latest services/media-ai-service
          docker push $AR/media-ai-service:latest

      - name: Build & Push client
        run: |
          docker build -t $AR/client:latest client
          docker push $AR/client:latest
  deploy-gke:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: app-chat-478713
      REGION: asia-southeast1
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: 'kubectl'

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials realtime-chat-autopilot-1 --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }}

      - name: Deploy manifests (Kustomize overlay)
        run: |
          kubectl apply -k cloud/k8s/overlays/gke

      - name: Rollout restart deployments
        run: |
          kubectl rollout restart deploy/api-gateway deploy/auth-user-service deploy/chat-service deploy/media-ai-service deploy/client
