version: "3.9"

services:

  # ============================================
  # üî• API GATEWAY
  # ============================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "3001:3001"
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://mongo:27017/chatapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend
      - frontend

  # ============================================
  # üîê AUTH & USER SERVICE
  # ============================================
  auth-user-service:
    build:
      context: ./services/auth-user-service
      dockerfile: Dockerfile
    container_name: auth-user-service
    ports:
      - "4001:4001"
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://mongo:27017/chatapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend

  # ============================================
  # üí¨ CHAT SERVICE
  # ============================================
  chat-service:
    build:
      context: ./services/chat-service
      dockerfile: Dockerfile
    container_name: chat-service
    ports:
      - "4002:4002"
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://mongo:27017/chatapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend

  # ============================================
  # ü§ñ MEDIA AI SERVICE
  # ============================================
  media-ai-service:
    build:
      context: ./services/media-ai-service
      dockerfile: Dockerfile
    container_name: media-ai-service
    ports:
      - "4003:4003"
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://mongo:27017/chatapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend

  # ============================================
  # üñ• FRONTEND CLIENT
  # ============================================
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client
    ports:
      - "5173:80"
    depends_on:
      api-gateway:
        condition: service_started
    restart: unless-stopped
    networks:
      - frontend

  # ============================================
  # üçÉ MONGO DATABASE
  # ============================================
  mongo:
    image: mongo:6
    container_name: mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - backend

  # ============================================
  # ‚ö° REDIS CACHE
  # ============================================
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    restart: unless-stopped
    networks:
      - backend

# ============================================
# üì¶ VOLUMES
# ============================================
volumes:
  mongo-data:

# ============================================
# üåê NETWORKS
# ============================================
networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge
